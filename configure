#!/bin/sh

if [ -z $BPCELLS_DEBUG_INSTALL ]; then 
    ERR=/dev/null
else
    ERR=/dev/stdout
    set -x
fi

# This curl request helps count daily installs prior to CRAN release:
# No identifiable information or IP addresses are saved, and server logs are
# deleted every 14 days. More information on data privacy policy: https://plausible.io/data-policy
# You can delete the line `ENABLE_INSTALL_COUNTING="yes"` if you do not want your installation counted.
ENABLE_INSTALL_COUNTING="yes"
if [ -n $ENABLE_INSTALL_COUNTING ]; then
    curl --silent "https://plausible.benparks.net/flask-plausible/bpcells-configure" > /dev/null 2> /dev/null \
        || true
fi

# Test compiling a simple hdf5 program to check for compatibility
CC=$("${R_HOME}/bin/R" CMD config CC)
CXX=$("${R_HOME}/bin/R" CMD config CXX)

CFLAGS=$("${R_HOME}/bin/R" CMD config CFLAGS)
CXXFLAGS=$("${R_HOME}/bin/R" CMD config CXXFLAGS)
LDFLAGS=$("${R_HOME}/bin/R" CMD config LDFLAGS)
############################
# HDF5 compatibility check
############################

echo "Testing hdf5 by compiling example program..."

# Vanilla install test
HDF5_CFLAGS=""
HDF5_LIBS="-lhdf5"
HDF5_OK=""
$CC tools/h5write.c $CFLAGS $LDFLAGS $HDF5_CFLAGS $HDF5_LIBS -o tools/h5write 2>$ERR && HDF5_OK="yes";

# pkg-config flags
if [ -z $HDF5_OK ]; then
    printf "\n\nRetrying with pkg-config flags...\n"
    if HDF5_CFLAGS="$(pkg-config hdf5 --cflags 2>$ERR)" && \
        HDF5_LIBS="$(pkg-config hdf5 --libs 2>$ERR)"; then
        $CC tools/h5write.c $CFLAGS $LDFLAGS $HDF5_CFLAGS $HDF5_LIBS -o tools/h5write 2>$ERR && HDF5_OK="yes";
    else
        echo "Error running 'pkg-config hdf5 --cflags --libs'"
    fi
fi

# conda env
if [ -z $HDF5_OK ]; then
    printf "\n\nSearching for hdf5 in a conda env...\n"
    if [ -z "$CONDA_PREFIX" ] ; then
        echo "no conda environment found in '\$CONDA_PREFIX'"
    else
        HDF5_CFLAGS="-I$CONDA_PREFIX/include"
        HDF5_LIBS="-Wl,-rpath,$CONDA_PREFIX/lib -L$CONDA_PREFIX/lib -lhdf5"
        $CC tools/h5write.c $CFLAGS $LDFLAGS $HDF5_CFLAGS $HDF5_LIBS -o tools/h5write 2>$ERR && HDF5_OK="yes";
    fi
fi

if [ -z $HDF5_OK ]; then
    printf "\n\nUnable to locate libhdf5. Please install manually or edit compiler flags.\n"
    exit 1
fi

echo "Found working hdf5"
echo "HDF5_CFLAGS='${HDF5_CFLAGS}'"
echo "HDF5_LIBS='${HDF5_LIBS}'"

############################
# Arch flag check
############################

ARCH_FLAG="-march=native"
printf "\nTesting architecture flag support support..."
for ARCH_FLAG in "-march=native" ""; do
    if $CC tools/h5write.c $ARCH_FLAG $CFLAGS $LDFLAGS $HDF5_CFLAGS $HDF5_LIBS -o tools/h5write 2>$ERR; then
        printf "'%s' succeeded\n" $ARCH_FLAG
        break;
    else
        printf "'%s' failed..." $ARCH_FLAG
    fi
done
echo "ARCH_FLAG='$ARCH_FLAG'"

############################
# C++17 filesystem check
############################
CXX17_OK=""
CXX_FS_FLAG=""
$CXX tools/cxx17_filesystem.cc $CXXFLAGS $LDFLAGS -std=c++17 $CXX_FS_FLAG -o tools/cxx17_filesystem 2>$ERR && CXX17_OK="yes";
if [ -z $CXX17_OK ]; then
    CXX_FS_FLAG="-lstdc++fs"
    $CXX tools/cxx17_filesystem.cc $CXXFLAGS $LDFLAGS -std=c++17 $CXX_FS_FLAG -o tools/cxx17_filesystem 2>$ERR && CXX17_OK="yes";
    if [ ! -z $CXX17_OK ]; then
        printf "\nWarning: your compiler version is old, and may run in to compile errors with BPCells.\n"
        printf "Consider installing a newer compiler version and setting CC and CXX in ~/.R/Makevars\n"
        printf "\nUsed fallback compatibility flags for C++17 std::filesystem support: $CXX_FS_FLAG\n"
    fi
fi
if [ -z $CXX17_OK ]; then
    printf "\n\nUnable to compile program with C++17 std::filesystem.\nPlease install a newer compiler version and set CC and CXX in ~/.R/Makevars\n"
    exit 1
fi

# Make substitutions in Makevars.in
sed \
    -e "s|%HDF5_CFLAGS%|${HDF5_CFLAGS}|g" \
    -e "s|%HDF5_LIBS%|${HDF5_LIBS}|g" \
    -e "s|%ARCH_FLAG%|${ARCH_FLAG}|g" \
    -e "s|%CXX_FS_FLAG%|${CXX_FS_FLAG}|g" \
    src/Makevars.in > src/Makevars

if [ -n $ENABLE_INSTALL_COUNTING ]; then
    curl --silent https://plausible.benparks.net/flask-plausible/bpcells-configure-success > /dev/null 2> /dev/null \
        || true
fi

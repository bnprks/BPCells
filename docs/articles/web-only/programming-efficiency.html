<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="BPCells">
<title>Efficiency tips • BPCells</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="Efficiency tips">
<meta property="og:description" content="BPCells">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="benparks.net" src="https://plausible.benparks.net/js/visit-counts.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">BPCells</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../articles/pbmc3k.html">Get Started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../../articles/pbmc3k.html">Basic tutorial</a>
    <a class="dropdown-item" href="../../articles/web-only/benchmarks.html">Performance Benchmarks</a>
    <a class="dropdown-item" href="../../articles/web-only/how-it-works.html">How BPCells works</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bnprks/BPCells/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Efficiency tips</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bnprks/BPCells/blob/HEAD/vignettes/web-only/programming-efficiency.Rmd" class="external-link"><code>vignettes/web-only/programming-efficiency.Rmd</code></a></small>
      <div class="d-none name"><code>programming-efficiency.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="normalizations-and-pca">Normalizations and PCA<a class="anchor" aria-label="anchor" href="#normalizations-and-pca"></a>
</h2>
<ul>
<li><p>Avoid dense matrices whenever possible. Put normalizations that
preserve sparsity (0 values stay 0) before normalizations that break
sparsity (e.g. adding values to each row/column). A typical RNA-seq
matrix has &lt;5% non-zero entries, so your code will operate on 20x
more entries with a dense matrix.</p></li>
<li>
<p>For most operations, we recommend using lazy evaluation to avoid
creating intermediate matrices. The one common exception to this rule is
when running PCA. Because PCA requires looping through the matrix
several hundred times, it is often faster to write the matrix to disk
once just before PCA rather than recalculating the entries on each PCA
iteration.</p>
<ul>
<li>For storage efficiency, keep any sparsity-breaking normalizations
delayed, but store all the sparse normalizations in a temporary location
with <code><a href="../../reference/matrix_io.html">write_matrix_dir()</a></code> then apply the sparsity-breaking
normalizations</li>
</ul>
</li>
<li><p>Adding values to the rows/columns of a matrix has very little
overhead for PCA because it translates into a pre or post processing
step before each mat-vec multiply iteration. As a sparsity-breaking
operation, adding a vector to the matrix causes most other operations to
become more expensive, however.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="storage-order">Storage order<a class="anchor" aria-label="anchor" href="#storage-order"></a>
</h2>
<ul>
<li>Sparse matrices can be stored in a row-major or column-major
orientation with BPCells. Along the indexed dimension (e.g. rows for
row-major), BPCells can efficiently seek to a selected column without
reading the whole matrix. This has performance implications for certain
operations:
<ul>
<li>Marker features can only be computed on a matrix indexed by
gene/feature.</li>
<li>Sparse matrix multiplication can only be performed between matrices
with the same storage order</li>
<li>Sparse matrix multiplication performance can change dramatically
depending on the storage order and relative matrix size/sparsity. For
column-major matrices, the left matrix should be fast to load and
contain few delayed operations, while the right matrix can be slow to
load and contain many delayed operations. For row-major matrices the
left/right preferences are reversed.</li>
</ul>
</li>
<li>You can check the storage order for a matrix by printing it out in
the R terminal</li>
<li>When calling the <code><a href="https://rdrr.io/r/base/t.html" class="external-link">t()</a></code> function, BPCells just flips a
boolean flag for whether the matrix is row-major or column-major. This
does not affect the underlying storage order.</li>
<li>To adjust the underlying storage order, call
<code><a href="../../reference/transpose_storage_order.html">transpose_storage_order()</a></code>. This is a slower operation, that
requires writing a new copy of the data to disk.</li>
</ul>
</div>
<div class="section level2">
<h2 id="other-tips">Other tips<a class="anchor" aria-label="anchor" href="#other-tips"></a>
</h2>
<ul>
<li>Use a single call to <code><a href="../../reference/matrix_stats.html">matrix_stats()</a></code> to calculate mean +
variance in a single pass through the matrix when possible. See the
function reference for details.</li>
<li>For ATAC-seq data, you can calculate variable features on the tile
matrix without ever saving it to disk. This allows you to subset to
variable tiles and create a peak matrix with just your variable tiles
for some space savings.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Benjamin Parks.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  <img src="https://plausible.benparks.net/flask-plausible/bpcells-docs.png" style="position:absolute;">
</body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="BPCells">
<title>How BPCells works â€¢ BPCells</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="How BPCells works">
<meta property="og:description" content="BPCells">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="benparks.net" src="https://plausible.benparks.net/js/visit-counts.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">BPCells</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../articles/pbmc3k.html">Get Started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../../articles/pbmc3k.html">Basic tutorial</a>
    <a class="dropdown-item" href="../../articles/web-only/benchmarks.html">Performance Benchmarks</a>
    <a class="dropdown-item" href="../../articles/web-only/how-it-works.html">How BPCells works</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bnprks/BPCells/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How BPCells works</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bnprks/BPCells/blob/HEAD/vignettes/web-only/how-it-works.Rmd" class="external-link"><code>vignettes/web-only/how-it-works.Rmd</code></a></small>
      <div class="d-none name"><code>how-it-works.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="operating-principles">Operating Principles<a class="anchor" aria-label="anchor" href="#operating-principles"></a>
</h2>
<p>Two key principles to understand about using BPCells is that all
operations are <em>streaming</em> and <em>lazy</em>.</p>
<p>Streaming means that only a minimal amount of data is stored in
memory while a computation is happening. There is almost no memory used
storing intermediate results. Hence, we can compute operations on large
matrices without ever loading them fully into memory.</p>
<p>Lazy means that no real work is performed on matrix or fragment
objects until the result needs to be returned as an R object or written
to disk. This helps support the streaming computation, since otherwise
we would be forced to compute intermediate results and use additional
memory.</p>
<div class="section level3">
<h3 id="basic-usage">Basic usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h3>
<p>We begin with a basic example of loading ATAC fragments from a 10x
fragments file, reading a peak set from a bed file, then calculating a
cell x peak matrix.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://bnprks.github.io/BPCells">"BPCells"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># File reading is lazy, so this is instantaneous</span></span>
<span><span class="va">fragments</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/open_fragments_10x.html">open_fragments_10x</a></span><span class="op">(</span><span class="st">"atac_fragments.tsv.gz"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This is when we actually read the file, should take 1-2 minutes to scan</span></span>
<span><span class="co"># since we bottleneck on gzip decompression.</span></span>
<span><span class="va">packed_fragments</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fragment_io.html">write_fragments_dir</a></span><span class="op">(</span><span class="va">fragments</span>, <span class="st">"pbmc-3k-fragments"</span><span class="op">)</span></span></code></pre></div>
<p>The bitpacked compressed fragment file is about half the size of the
10x file, and much faster to read.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Later, we can re-open these fragments</span></span>
<span><span class="va">packed_fragments</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/fragment_io.html">open_fragments_dir</a></span><span class="op">(</span><span class="st">"pbmc-3k_fragments"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/read_bed.html">read_bed</a></span><span class="op">(</span><span class="st">"peaks.bed"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This is fast because the peak matrix calculation is lazy.</span></span>
<span><span class="co"># It will be computed on-the-fly when we actually need results from it.</span></span>
<span><span class="va">peak_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/peak_matrix.html">peak_matrix</a></span><span class="op">(</span><span class="va">packed_fragments</span>, <span class="va">peaks</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Here is where the peak matrix calculation happens. Runs over 10-times</span></span>
<span><span class="co"># faster than ArchR, which utilizes IRanges to perform overlap calculations.</span></span>
<span><span class="va">R_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">peak_matrix</span>, <span class="st">"dgCMatrix"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="streaming-operations">Streaming operations<a class="anchor" aria-label="anchor" href="#streaming-operations"></a>
</h3>
<p>The lazy, stream-oriented design means that we can calculate more
complicated transformations in a single pass. This is both faster and
more memory-efficient than calculating several intermediate results in a
sequential manner.</p>
<p>As an example, we will perform the following pipeline: 1. Exclude
fragments from non-standard chromosomes 2. Subset our cells 3. Add a Tn5
offset 4. Calculate the peak matrix 5. Calculate the mean-accessibility
per peak</p>
<p>If this were done using e.g.Â GRanges or sparse matrices, we would
need to do 3 passes through the fragments while saving intermediate
results, and 2 passes over the peak matrix.</p>
<p>With BPCellâ€™s streaming operations, this can all be done directly
from the fragments in a single pass, and the memory usage is limited to
a few bytes per cell for iterating over the peak matrix and returning
the colMeans.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Here I make use of the new pipe operator |&gt; for better readability</span></span>
<span></span>
<span><span class="co"># We'll subset to just the standard chromosomes</span></span>
<span><span class="va">standard_chr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span></span>
<span>  <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="../../reference/IterableFragments-methods.html">chrNames</a></span><span class="op">(</span><span class="va">packed_fragments</span><span class="op">)</span>, <span class="st">"^chr[0-9XY]+$"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pick a random subset of 100 cells to consider</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1337</span><span class="op">)</span></span>
<span><span class="va">keeper_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="../../reference/IterableFragments-methods.html">cellNames</a></span><span class="op">(</span><span class="va">packed_fragments</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the pipeline, and save the average accessibility per peak</span></span>
<span><span class="va">peak_accessibility</span> <span class="op">&lt;-</span> <span class="va">packed_fragments</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../../reference/select_chromosomes.html">select_chromosomes</a></span><span class="op">(</span><span class="va">standard_chr</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../../reference/select_cells.html">select_cells</a></span><span class="op">(</span><span class="va">keeper_cells</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../../reference/shift_fragments.html">shift_fragments</a></span><span class="op">(</span>shift_start<span class="op">=</span><span class="fl">4</span>, shift_end<span class="op">=</span><span class="op">-</span><span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../../reference/peak_matrix.html">peak_matrix</a></span><span class="op">(</span><span class="va">peaks</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">colMeans</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Note that if we knew the cell names ahead of time, we could even
perform this operation directly on our orignal 10x fragments without
ever saving the fragments into memory. This would be fairly slow because
10x fragment files are slow to decompress, so itâ€™s recommended to
convert to the BPCells format.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Benjamin Parks.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  <img src="https://plausible.benparks.net/flask-plausible/bpcells-docs.png" style="position:absolute;">
</body>
</html>

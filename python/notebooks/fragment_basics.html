
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Basepair insertion counts tutorial &#8212; bpcells  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/fragment_basics';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Matrix slicing tutorial" href="matrix_basics.html" />
    <link rel="prev" title="bpcells.experimental.MemMatrix.transpose" href="../generated/bpcells.experimental.MemMatrix.transpose.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">bpcells  documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../python.html">
    Python Docs
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://bnprks.github.io/BPCells">
    R Docs
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bnprks/BPCells" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../python.html">
    Python Docs
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://bnprks.github.io/BPCells">
    R Docs
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bnprks/BPCells" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/fragments.html">Fragment functions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../generated/bpcells.experimental.import_10x_fragments.html">bpcells.experimental.import_10x_fragments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/bpcells.experimental.build_cell_groups.html">bpcells.experimental.build_cell_groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/bpcells.experimental.pseudobulk_insertion_counts.html">bpcells.experimental.pseudobulk_insertion_counts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generated/bpcells.experimental.precalculate_insertion_counts.html">bpcells.experimental.precalculate_insertion_counts</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../generated/bpcells.experimental.PrecalculatedInsertionMatrix.html">bpcells.experimental.PrecalculatedInsertionMatrix</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.PrecalculatedInsertionMatrix.shape.html">bpcells.experimental.PrecalculatedInsertionMatrix.shape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.PrecalculatedInsertionMatrix.get_counts.html">bpcells.experimental.PrecalculatedInsertionMatrix.get_counts</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/matrix.html">Matrix functions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.html">bpcells.experimental.DirMatrix</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.T.html">bpcells.experimental.DirMatrix.T</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.shape.html">bpcells.experimental.DirMatrix.shape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.threads.html">bpcells.experimental.DirMatrix.threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.from_h5ad.html">bpcells.experimental.DirMatrix.from_h5ad</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.from_hstack.html">bpcells.experimental.DirMatrix.from_hstack</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.from_scipy_sparse.html">bpcells.experimental.DirMatrix.from_scipy_sparse</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.from_vstack.html">bpcells.experimental.DirMatrix.from_vstack</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.DirMatrix.transpose.html">bpcells.experimental.DirMatrix.transpose</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../generated/bpcells.experimental.MemMatrix.html">bpcells.experimental.MemMatrix</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.MemMatrix.T.html">bpcells.experimental.MemMatrix.T</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.MemMatrix.shape.html">bpcells.experimental.MemMatrix.shape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.MemMatrix.threads.html">bpcells.experimental.MemMatrix.threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated/bpcells.experimental.MemMatrix.transpose.html">bpcells.experimental.MemMatrix.transpose</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Basepair insertion counts tutorial</a></li>

<li class="toctree-l1"><a class="reference internal" href="matrix_basics.html">Matrix slicing tutorial</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../python.html" class="nav-link">Python Docs</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Basepair...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="basepair-insertion-counts-tutorial">
<h1>Basepair insertion counts tutorial<a class="headerlink" href="#basepair-insertion-counts-tutorial" title="Link to this heading">#</a></h1>
<p>BPCells python bindings can be used to query basepair-level coverage for predefined cell types.</p>
<p>The way this works is in two steps:</p>
<ol class="arabic simple">
<li><p>10x or ArchR arrow files are converted to BPCells format. This is most flexible to do with the BPCells R bindings, though single-sample 10x import is supported through the python bindings.</p></li>
<li><p>The BPCells python bindings use the input fragment files to create large matrix of dimensions (# cell types, # basepairs in genome). This is where cell type groupings are determined.</p></li>
<li><p>The BPCells python bindings can slice arbitrary genomic regions, returning a numpy array of dimensions (regions, cell types, basepairs)</p></li>
</ol>
<section id="benchmark-estimates">
<h2>Benchmark estimates<a class="headerlink" href="#benchmark-estimates" title="Link to this heading">#</a></h2>
<p>Benchmark dataset: 600K cell subset of the <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0092867421012794">Catlas paper</a>, with 2.5 billion fragments
Benchmark task: Load 128 random 501-bp peak regions from 111 cell types at basepair resolution
Storage location: Local SSD. Networked file systems will be slower</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>BPCells</p></th>
<th class="head"><p>BigWigs</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Creation time</p></td>
<td><p>4.7 minutes, 8 threads</p></td>
<td><p>?</p></td>
</tr>
<tr class="row-odd"><td><p>File size</p></td>
<td><p>6.2 GB</p></td>
<td><p>13 GB</p></td>
</tr>
<tr class="row-even"><td><p>Query time</p></td>
<td><p>0.37 seconds</p></td>
<td><p>2.2 seconds</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="main-benefits-of-bpcells">
<h2>Main benefits of BPCells<a class="headerlink" href="#main-benefits-of-bpcells" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Cell type count aggregation can be re-run fully from Python</p></li>
<li><p>Query time is about 6x faster than BigWigs</p></li>
</ul>
<p><strong>Caveat for this prototype</strong>: due to development time limitations, this insertion matrix implementation does not support &gt;=2^32 non-zero entries (4.29 billion). The catlas dataset had about 3.2 billion non-zero entries. This limitation can be removed with additional technical work, or as a workaround multiple matrix objects can be created that each individually have &lt;2^32 non-zero entries.</p>
</section>
</section>
<section id="usage-demo">
<h1>Usage Demo<a class="headerlink" href="#usage-demo" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpcells.experimental</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<section id="data-download">
<h2>Data download<a class="headerlink" href="#data-download" title="Link to this heading">#</a></h2>
<p>We use a public 500-cell 10x dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
<span class="n">fragments_10x_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;atac_fragments.tsv.gz&quot;</span><span class="p">)</span>

<span class="n">data_url</span> <span class="o">=</span> <span class="s2">&quot;https://cf.10xgenomics.com/samples/cell-atac/2.0.0/atac_pbmc_500_nextgem/atac_pbmc_500_nextgem_fragments.tsv.gz&quot;</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;--silent&quot;</span><span class="p">,</span> <span class="n">data_url</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fragments_10x_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CompletedProcess(args=[&#39;curl&#39;, &#39;--silent&#39;, &#39;https://cf.10xgenomics.com/samples/cell-atac/2.0.0/atac_pbmc_500_nextgem/atac_pbmc_500_nextgem_fragments.tsv.gz&#39;], returncode=0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_url</span> <span class="o">=</span> <span class="s2">&quot;https://cf.10xgenomics.com/samples/cell-atac/2.0.0/atac_pbmc_500_nextgem/atac_pbmc_500_nextgem_singlecell.csv&quot;</span>
<span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;cell_metadata.csv&quot;</span><span class="p">)</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;--silent&quot;</span><span class="p">,</span> <span class="n">metadata_url</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">))</span>

<span class="n">cell_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">)</span>
<span class="n">cell_metadata</span> <span class="o">=</span> <span class="n">cell_metadata</span><span class="p">[</span><span class="n">cell_metadata</span><span class="o">.</span><span class="n">is__cell_barcode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">cell_metadata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>barcode</th>
      <th>total</th>
      <th>duplicate</th>
      <th>chimeric</th>
      <th>unmapped</th>
      <th>lowmapq</th>
      <th>mitochondrial</th>
      <th>nonprimary</th>
      <th>passed_filters</th>
      <th>is__cell_barcode</th>
      <th>excluded_reason</th>
      <th>TSS_fragments</th>
      <th>DNase_sensitive_region_fragments</th>
      <th>enhancer_region_fragments</th>
      <th>promoter_region_fragments</th>
      <th>on_target_fragments</th>
      <th>blacklist_region_fragments</th>
      <th>peak_region_fragments</th>
      <th>peak_region_cutsites</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1093</td>
      <td>AAACTGCAGACTCGGA-1</td>
      <td>26219</td>
      <td>15751</td>
      <td>6</td>
      <td>184</td>
      <td>1310</td>
      <td>0</td>
      <td>3</td>
      <td>8965</td>
      <td>1</td>
      <td>0</td>
      <td>4499</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4499</td>
      <td>0</td>
      <td>6264</td>
      <td>11966</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1807</td>
      <td>AAAGATGCACCTATTT-1</td>
      <td>43137</td>
      <td>25369</td>
      <td>7</td>
      <td>239</td>
      <td>2544</td>
      <td>0</td>
      <td>7</td>
      <td>14971</td>
      <td>1</td>
      <td>0</td>
      <td>7135</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>7135</td>
      <td>0</td>
      <td>9825</td>
      <td>18819</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1828</td>
      <td>AAAGATGCAGATACAA-1</td>
      <td>129867</td>
      <td>91043</td>
      <td>28</td>
      <td>839</td>
      <td>9577</td>
      <td>0</td>
      <td>40</td>
      <td>28340</td>
      <td>1</td>
      <td>0</td>
      <td>16771</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>16771</td>
      <td>0</td>
      <td>21166</td>
      <td>40512</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3144</td>
      <td>AAAGGGCTCGCTCTAC-1</td>
      <td>97970</td>
      <td>63834</td>
      <td>16</td>
      <td>492</td>
      <td>5080</td>
      <td>0</td>
      <td>1</td>
      <td>28547</td>
      <td>1</td>
      <td>0</td>
      <td>13504</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>13504</td>
      <td>0</td>
      <td>18688</td>
      <td>35366</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3300</td>
      <td>AAATGAGAGTCCCGCA-1</td>
      <td>16066</td>
      <td>7440</td>
      <td>0</td>
      <td>71</td>
      <td>805</td>
      <td>0</td>
      <td>0</td>
      <td>7750</td>
      <td>1</td>
      <td>0</td>
      <td>3619</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3619</td>
      <td>0</td>
      <td>5287</td>
      <td>10165</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>479</th>
      <td>248048</td>
      <td>TTTGGCCAGATCTAAG-1</td>
      <td>97255</td>
      <td>63290</td>
      <td>22</td>
      <td>551</td>
      <td>8536</td>
      <td>0</td>
      <td>1643</td>
      <td>23213</td>
      <td>1</td>
      <td>0</td>
      <td>11383</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>11383</td>
      <td>0</td>
      <td>16123</td>
      <td>30530</td>
    </tr>
    <tr>
      <th>480</th>
      <td>248113</td>
      <td>TTTGGCCAGTACAGAT-1</td>
      <td>15054</td>
      <td>7596</td>
      <td>3</td>
      <td>115</td>
      <td>794</td>
      <td>13</td>
      <td>0</td>
      <td>6533</td>
      <td>1</td>
      <td>0</td>
      <td>3264</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3264</td>
      <td>0</td>
      <td>4617</td>
      <td>8813</td>
    </tr>
    <tr>
      <th>481</th>
      <td>248137</td>
      <td>TTTGGCCAGTGCTCGC-1</td>
      <td>54672</td>
      <td>32244</td>
      <td>8</td>
      <td>300</td>
      <td>3455</td>
      <td>0</td>
      <td>2</td>
      <td>18663</td>
      <td>1</td>
      <td>0</td>
      <td>11252</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>11252</td>
      <td>0</td>
      <td>13312</td>
      <td>25376</td>
    </tr>
    <tr>
      <th>482</th>
      <td>248322</td>
      <td>TTTGGCCGTCCCGTGA-1</td>
      <td>60394</td>
      <td>32487</td>
      <td>9</td>
      <td>546</td>
      <td>3196</td>
      <td>0</td>
      <td>0</td>
      <td>24156</td>
      <td>1</td>
      <td>0</td>
      <td>10596</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>10596</td>
      <td>0</td>
      <td>14413</td>
      <td>27039</td>
    </tr>
    <tr>
      <th>483</th>
      <td>248733</td>
      <td>TTTGGTTCAGAGATGC-1</td>
      <td>66942</td>
      <td>36246</td>
      <td>23</td>
      <td>369</td>
      <td>3904</td>
      <td>174</td>
      <td>11</td>
      <td>26215</td>
      <td>1</td>
      <td>0</td>
      <td>13128</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>13128</td>
      <td>0</td>
      <td>17938</td>
      <td>34256</td>
    </tr>
  </tbody>
</table>
<p>484 rows Ã— 20 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_metadata</span><span class="o">.</span><span class="n">is__cell_barcode</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.int64(484)
</pre></div>
</div>
</div>
</div>
</section>
<section id="convert-to-bpcells-format">
<h2>Convert to BPCells format<a class="headerlink" href="#convert-to-bpcells-format" title="Link to this heading">#</a></h2>
<p>Notice that the conversion allows for adjusting the start/end coordinates, as well as subsetting to only the barcodes passing QC. Adding 1 to the end coordinate is necessary for 10x inputs produced by cellranger</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">fragments_bpcells_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;bpcells_fragments&quot;</span><span class="p">)</span>
<span class="n">bpcells</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">import_10x_fragments</span><span class="p">(</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">fragments_10x_path</span><span class="p">,</span> 
    <span class="n">output</span> <span class="o">=</span> <span class="n">fragments_bpcells_path</span><span class="p">,</span> 
    <span class="n">shift_end</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">keeper_cells</span><span class="o">=</span><span class="n">cell_metadata</span><span class="o">.</span><span class="n">barcode</span><span class="p">[</span><span class="n">cell_metadata</span><span class="o">.</span><span class="n">is__cell_barcode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 3.43 s, sys: 74.9 ms, total: 3.51 s
Wall time: 3.45 s
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-the-insertion-matrix">
<h2>Create the insertion matrix<a class="headerlink" href="#create-the-insertion-matrix" title="Link to this heading">#</a></h2>
<p>To calculate the insertion matrix, we first define our cell groups, as well as the ordering of the cell groups we want for our output matrix. Here we use the first two characters of the cell barcode since annotated cell types are not available. Note that it is possible to leave cells out when calling <code class="docutils literal notranslate"><span class="pre">build_cell_groups</span></code>, in which case that data will not be included in the precalculated matrix</p>
<p>Next, we precalculate the insertion counts matrix, which can use parallelization to speed up portions of the work.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">barcodes</span> <span class="o">=</span> <span class="n">cell_metadata</span><span class="o">.</span><span class="n">barcode</span>
<span class="n">clusters</span> <span class="o">=</span> <span class="n">cell_metadata</span><span class="o">.</span><span class="n">barcode</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">cluster_order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span>

<span class="n">cell_groups_array</span> <span class="o">=</span> <span class="n">bpcells</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">build_cell_groups</span><span class="p">(</span><span class="n">fragments_bpcells_path</span><span class="p">,</span> <span class="n">barcodes</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">cluster_order</span><span class="p">)</span>

<span class="c1"># We could provide a dict or local file path, but URL is easier</span>
<span class="n">chrom_sizes</span> <span class="o">=</span> <span class="s2">&quot;http://hgdownload.cse.ucsc.edu/goldenpath/hg38/bigZips/hg38.chrom.sizes&quot;</span>

<span class="n">insertions_matrix_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;bpcells_insertions_matrix&quot;</span><span class="p">)</span>

<span class="n">bpcells</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">precalculate_insertion_counts</span><span class="p">(</span>
    <span class="n">fragments_bpcells_path</span><span class="p">,</span> 
    <span class="n">insertions_matrix_path</span><span class="p">,</span> 
    <span class="n">cell_groups_array</span><span class="p">,</span> 
    <span class="n">chrom_sizes</span><span class="p">,</span> 
    <span class="n">threads</span><span class="o">=</span><span class="mi">4</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 3min 8s, sys: 710 ms, total: 3min 8s
Wall time: 1min 45s
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;PrecalculatedInsertionMatrix with 16 pseudobulks and 24 chromomsomes stored in 
	/tmp/tmpenistmm7/bpcells_insertions_matrix
</pre></div>
</div>
</div>
</div>
</section>
<section id="querying-the-insertion-matrix">
<h2>Querying the insertion matrix<a class="headerlink" href="#querying-the-insertion-matrix" title="Link to this heading">#</a></h2>
<p>We can load the pre-calculated matrix from its input path.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mat</span> <span class="o">=</span> <span class="n">bpcells</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">PrecalculatedInsertionMatrix</span><span class="p">(</span><span class="n">insertions_matrix_path</span><span class="p">)</span>
<span class="n">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;PrecalculatedInsertionMatrix with 16 pseudobulks and 24 chromomsomes stored in 
	/tmp/tmpenistmm7/bpcells_insertions_matrix
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.uint32(16), np.uint32(3088269832))
</pre></div>
</div>
</div>
</div>
<p>To query the matrix, we use a pandas DataFrame, with columns (chrom, start, end). All the regions must be the same length</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;chrom&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span> <span class="s2">&quot;chr1&quot;</span><span class="p">,</span> <span class="s2">&quot;chr6&quot;</span><span class="p">],</span>
    <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="mi">2_000_000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">],</span>
<span class="p">})</span>
<span class="n">query_regions</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_regions</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1000</span>
<span class="n">query_regions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>chrom</th>
      <th>start</th>
      <th>end</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>chr1</td>
      <td>1000000</td>
      <td>1001000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>chr1</td>
      <td>2000000</td>
      <td>2001000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>chr6</td>
      <td>10000000</td>
      <td>10001000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>BPCells returns a numpy array of dimensions (regions, cell types, basepairs), holding the per-base counts for each cell type</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">get_counts</span><span class="p">(</span><span class="n">query_regions</span><span class="p">)</span>
<span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[[0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        ...,
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0]],

       [[0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        ...,
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0]],

       [[0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        ...,
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0]]], dtype=int32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(3, 16, 1000)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.int64(363)
</pre></div>
</div>
</div>
</div>
</section>
<section id="pytorch-compatible-dataset">
<h2>Pytorch-compatible dataset<a class="headerlink" href="#pytorch-compatible-dataset" title="Link to this heading">#</a></h2>
<p>It is simple to wrap this matrix as a pytorch-compatible dataset, given a set of regions for the training set. Note the use of the non-standard <code class="docutils literal notranslate"><span class="pre">__getitems__()</span></code> function which pytorch uses to provide batched loading for higher performance. This dataset object can be directly passed to <code class="docutils literal notranslate"><span class="pre">torch.utils.data.DataLoader</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BPCellsDataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">matrix_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[[</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">]]</span>

        <span class="n">matrix_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">matrix_dir</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">bpcells</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">PrecalculatedInsertionMatrix</span><span class="p">(</span><span class="n">matrix_dir</span><span class="p">)</span>
        
        <span class="n">peak_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">peak_width</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getitems__</span><span class="p">([</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitems__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="c1"># Adding this function allows for batched loading</span>
        <span class="c1"># See: https://github.com/pytorch/pytorch/issues/107218</span>

        <span class="c1"># Return tensor of shape (batch_size, n_tasks, basepairs)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">get_counts</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">,]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../generated/bpcells.experimental.MemMatrix.transpose.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">bpcells.experimental.MemMatrix.transpose</p>
      </div>
    </a>
    <a class="right-next"
       href="matrix_basics.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Matrix slicing tutorial</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Basepair insertion counts tutorial</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#benchmark-estimates">Benchmark estimates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-benefits-of-bpcells">Main benefits of BPCells</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#usage-demo">Usage Demo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-download">Data download</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-to-bpcells-format">Convert to BPCells format</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-insertion-matrix">Create the insertion matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#querying-the-insertion-matrix">Querying the insertion matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytorch-compatible-dataset">Pytorch-compatible dataset</a></li>
</ul>
</li>
</ul>

  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/notebooks/fragment_basics.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2023, Ben Parks.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>